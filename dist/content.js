(()=>{function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=Array(t);o<t;o++)n[o]=e[o];return n}var t="both",o="api",n="keywords",r=[{bgColor:"#d81b60",textColor:"#ffffff"},{bgColor:"#8e24aa",textColor:"#ffffff"},{bgColor:"#5e35b1",textColor:"#ffffff"},{bgColor:"#3949ab",textColor:"#ffffff"},{bgColor:"#1e88e5",textColor:"#ffffff"},{bgColor:"#00897b",textColor:"#ffffff"},{bgColor:"#43a047",textColor:"#ffffff"},{bgColor:"#e53935",textColor:"#ffffff"},{bgColor:"#f4511e",textColor:"#ffffff"},{bgColor:"#6d4c41",textColor:"#ffffff"}],l={},i=1,a=[],s=t,c=new Set;function d(t,o){if(!t||!o||0===o.length)return!1;var n=t.toLowerCase(),r=o.filter((function(e){return!a.includes(e.toLowerCase())}));if(0===r.length)return!1;var l,i=function(t,o){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,o){if(t){if("string"==typeof t)return e(t,o);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){n&&(t=n);var r=0,l=function(){};return{s:l,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(e){throw e},f:l}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}(r);try{for(i.s();!(l=i.n()).done;){var s=l.value;try{if(new RegExp("\\b"+s+"\\b","i").test(n))return s}catch(e){continue}}}catch(e){i.e(e)}finally{i.f()}return!1}function f(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e&&e.textContent&&!c.has(e)&&!(a&&s===n||!a&&s===o)){console.log("Hiding spoiler content:",t),c.add(e);var d="spoiler-".concat(i++);l[d]={originalContent:e.innerHTML,reason:t,isFromApi:a};var f,g=(f=Math.floor(Math.random()*r.length),r[f]),u=document.createElement("div");u.className="spoiler-warning",u.setAttribute("data-spoiler-id",d),u.textContent=a?"ðŸ›‘ SPOILERS AHEAD (AI) ðŸ›‘":"ðŸ›‘ SPOILERS AHEAD ðŸ›‘",u.setAttribute("data-source",a?"api":"keyword"),u.style.backgroundColor=g.bgColor,u.style.color=g.textColor,u.style.padding="5px 10px",u.style.margin="5px 0",u.style.borderRadius="4px",u.style.cursor="pointer",u.style.display="block",u.style.fontFamily="Arial, sans-serif",u.style.fontSize="14px",u.style.textAlign="center",u.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",u.title="Click to reveal spoiler content",e.innerHTML="",e.appendChild(u)}}function g(){console.log("Starting API spoiler detection");var e=function(){if(console.log("Collecting text blocks for API processing"),s===n)return console.log("Skipping API detection in keywords-only mode"),[];var e=[];if([{selector:"p",minLength:15},{selector:"li",minLength:15},{selector:"span",minLength:30},{selector:"div:not(:has(> p))",minLength:30},{selector:"td",minLength:15},{selector:"h1, h2, h3, h4, h5, h6",minLength:15}].forEach((function(t){try{document.querySelectorAll(t.selector).forEach((function(o){var n;if(!c.has(o)){var r=null===(n=o.textContent)||void 0===n?void 0:n.trim();if(r&&!(r.length<t.minLength))if(r.length>200){var l=function(e){return e.replace(/([.!?])\s*(?=[A-Z])/g,"$1|").split("|").map((function(e){return e.trim()})).filter((function(e){return e.length>=15}))}(r);l.forEach((function(t){e.push({element:o,text:t})}))}else e.push({element:o,text:r})}}))}catch(e){console.error("Error processing ".concat(t.selector," elements:"),e)}})),console.log("Collected ".concat(e.length," text blocks for API processing")),e.length>0){console.log("Sample text blocks:");for(var t=0;t<Math.min(5,e.length);t++)console.log("".concat(t+1,". ").concat(e[t].text.substring(0,50),"... (").concat(e[t].element.tagName,")"))}return e}();0!==e.length?function(e){if(e&&0!==e.length){var t=e.slice(0,50);console.log("Processing ".concat(t.length," text blocks with API in batches of ").concat(20));for(var o=function(e){var o=t.slice(e,e+20);setTimeout((function(){!function(e,t){if(e&&0!==e.length){console.log("Processing API batch #".concat(t," with ").concat(e.length," blocks")),console.log("Text being sent to API:"),e.forEach((function(e,t){console.log("".concat(t+1,'. "').concat(e.text.substring(0,50),'..."'))}));var o=e.map((function(e){return e.text})),n="Basic "+btoa("".concat("admin",":").concat("password123"));fetch("https://spoilerdetector.site/predict",{method:"POST",headers:{"Content-Type":"application/json",Authorization:n},body:JSON.stringify({texts:o}),mode:"cors"}).then((function(e){if(!e.ok)throw new Error("API request failed: ".concat(e.status));return e.text()})).then((function(e){try{return console.log("API response for batch #".concat(t,":"),e.substring(0,100)+"..."),JSON.parse(e)}catch(t){throw console.error("Error parsing API response:",t),console.error("Raw response:",e),new Error("Failed to parse API response")}})).then((function(o){if(Array.isArray(o)){console.log("API batch #".concat(t," returned ").concat(o.length," results"));var n=0;o.forEach((function(t,o){if(o<e.length&&!0===t.spoiler){n++;var r=e[o].element,l=e[o].text.substring(0,50)+"...";console.log("API detected spoiler #".concat(n,' in: "').concat(l,'"')),f(r,"API detected spoiler",!0)}})),console.log("API batch #".concat(t," found ").concat(n," spoilers"))}else console.error("Invalid API response format:",o)})).catch((function(e){console.error("Error in API batch #".concat(t,":"),e)}))}}(o,e/20+1)}),200*e)},n=0;n<t.length;n+=20)o(n)}}(e):console.log("No text blocks found for API detection")}function u(e){for(var t=e.target;t&&!t.classList.contains("spoiler-warning");){if(t===document.body)return;t=t.parentElement}if(t){var o=t.getAttribute("data-spoiler-id");if(o&&l[o]){var n=l[o],r=t.parentElement,i=n.reason;i&&i.startsWith("Keyword match:")&&function(e){if(e){var t=e.toLowerCase();a.includes(t)||(a.push(t),console.log("Added ignored keyword:",t),chrome.storage.local.set({ignoredKeywords:a},(function(){console.log("Saved ignored keywords to storage")})))}}(i.substring(14).trim()),r.innerHTML=n.originalContent,r.setAttribute("data-spoiler-revealed","true"),delete l[o],p()}}}function p(){var e=document.getElementById("spoiler-reset-button");e&&e.remove();var t=document.createElement("button");t.id="spoiler-reset-button",t.textContent="Reset Spoilers",t.onclick=h,t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.zIndex="999999",t.style.backgroundColor="#f44336",t.style.color="white",t.style.border="none",t.style.borderRadius="4px",t.style.padding="8px 16px",t.style.fontSize="14px",t.style.cursor="pointer",t.style.boxShadow="0 2px 5px rgba(0,0,0,0.3)",document.body.appendChild(t)}function h(){a=[],chrome.storage.local.remove("ignoredKeywords",(function(){console.log("Cleared ignored keywords"),window.location.reload()}))}function y(e){console.log("Starting spoiler detection in mode:",s),e&&0!==e.length?(s!==t&&s!==n||function(e){if(console.log("Checking for keyword spoilers with:",e),e&&0!==e.length)if(s!==o){var t=e.filter((function(e){return e&&e.length>=3}));if(0!==t.length){var n=document.querySelectorAll("p"),r=document.querySelectorAll("li"),l=document.querySelectorAll("span");console.log("Checking "+n.length+" paragraphs, "+r.length+" list items, and "+l.length+" spans"),n.forEach((function(e){if(!c.has(e)){var o=e.textContent;if(o&&!(o.length<15)){var n=d(o,t);n&&f(e,"Keyword match: "+n,!1)}}})),r.forEach((function(e){if(!c.has(e)){var o=e.textContent;if(o&&!(o.length<15)){var n=d(o,t);n&&f(e,"Keyword match: "+n,!1)}}})),l.forEach((function(e){if(!c.has(e)){var o=e.textContent;if(o&&!(o.length<30)){var n=d(o,t);n&&f(e,"Keyword match: "+n,!1)}}}))}}else console.log("Skipping keyword detection in API-only mode")}(e),s!==t&&s!==o||setTimeout((function(){g()}),500)):console.log("No keywords to check")}function m(){console.log("Initializing spoiler blocker with dropdown mode selector");var e=document.createElement("style");e.textContent='\n    .spoiler-warning {\n      display: block !important;\n      text-align: center !important;\n      font-weight: bold !important;\n      cursor: pointer !important;\n    }\n    \n    [data-spoiler-revealed="true"] {\n      /* Mark elements that have had spoilers revealed */\n    }\n    \n    #spoiler-mode-dropdown option {\n      padding: 5px;\n    }\n  ',document.head.appendChild(e),chrome.storage.local.get("detectionMode",(function(e){var t;e.detectionMode&&(s=e.detectionMode),console.log("Using detection mode:",s),t=function(){chrome.runtime.sendMessage({action:"getKeywords"},(function(e){e&&e.keywords&&e.keywords.length>0?(console.log("Received keywords:",e.keywords),y(e.keywords),setTimeout((function(){y(e.keywords)}),2e3)):console.log("No keywords received")}))},chrome.storage.local.get("ignoredKeywords",(function(e){e.ignoredKeywords&&Array.isArray(e.ignoredKeywords)&&(a=e.ignoredKeywords,console.log("Loaded ignored keywords:",a)),t&&t()}))})),document.addEventListener("click",u),function(){var e=document.getElementById("spoiler-mode-dropdown");e&&e.remove();var r=document.createElement("div");r.id="spoiler-mode-container",r.style.position="fixed",r.style.bottom="20px",r.style.right="160px",r.style.zIndex="999999",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.padding="10px",r.style.borderRadius="8px",r.style.backgroundColor="#3949ab",r.style.boxShadow="0 4px 8px rgba(0,0,0,0.3)";var i=document.createElement("label");i.textContent="Detection Mode",i.style.marginBottom="6px",i.style.fontSize="14px",i.style.fontWeight="bold",i.style.color="white",i.style.fontFamily="Arial, sans-serif",i.htmlFor="spoiler-mode-dropdown";var a=document.createElement("select");a.id="spoiler-mode-dropdown",a.style.padding="8px 12px",a.style.borderRadius="4px",a.style.border="2px solid #ffeb3b",a.style.backgroundColor="#fff",a.style.color="#333",a.style.fontSize="14px",a.style.fontWeight="bold",a.style.cursor="pointer",a.style.width="150px",a.style.appearance="none",a.style.WebkitAppearance="none",a.style.MozAppearance="none",a.style.backgroundImage='url(\'data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>\')',a.style.backgroundRepeat="no-repeat",a.style.backgroundPosition="right 8px center",a.style.paddingRight="30px";var d=[{value:t,text:"Both Methods",color:"#3949ab"},{value:o,text:"API Only",color:"#43a047"},{value:n,text:"Keywords Only",color:"#e53935"}];d.forEach((function(e){var t=document.createElement("option");t.value=e.value,t.textContent=e.text,t.style.backgroundColor=e.color,t.style.color="white",t.style.fontWeight="bold",e.value===s&&(t.selected=!0,r.style.backgroundColor=e.color),a.appendChild(t)})),a.onchange=function(){var e,t=d.find((function(e){return e.value===a.value}));t&&(r.style.backgroundColor=t.color),(e=a.value)!==s&&(console.log("Changing detection mode from ".concat(s," to ").concat(e)),s=e,chrome.storage.local.set({detectionMode:e},(function(){console.log("Saved detection mode:",e)})),console.log("Updating spoiler visibility for mode:",s),function(){var e=document.getElementById("spoiler-loading-overlay");e&&e.remove();var t=document.createElement("div");t.id="spoiler-loading-overlay",t.style.position="fixed",t.style.bottom="80px",t.style.right="30px",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.zIndex="999999",t.style.fontFamily="Arial, sans-serif",t.style.fontSize="14px",t.textContent="Updating spoilers...",document.body.appendChild(t)}(),document.querySelectorAll(".spoiler-warning").forEach((function(e){var t=e.getAttribute("data-spoiler-id");if(t&&l[t]){var r=l[t],i=r.isFromApi,a=e.parentElement,c=!0;s!==o||i?s===n&&i&&(c=!1):c=!1,c||(a.innerHTML=r.originalContent,a.setAttribute("data-spoiler-revealed","true"),delete l[t])}})),setTimeout((function(){c.clear(),chrome.runtime.sendMessage({action:"getKeywords"},(function(e){var t;e&&e.keywords&&e.keywords.length>0&&y(e.keywords),(t=document.getElementById("spoiler-loading-overlay"))&&t.remove()}))}),300))},r.appendChild(i),r.appendChild(a),document.body.appendChild(r),console.log("Colorful mode dropdown created")}(),a.length>0&&p()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m(),chrome.runtime.onMessage.addListener((function(e){"settingsUpdated"===e.action?window.location.reload():"resetAll"===e.action&&h()}))})();